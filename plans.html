<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plans Enregistr√©s</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .plan-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .plan-card img, .plan-card embed {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üìÅ Plans Enregistr√©s</h1>
  <form id="planForm" enctype="multipart/form-data" style="background:#f1f5fb;border-radius:8px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 1px 4px #0001;max-width:500px;margin:auto;">
    <label for="planDesc">Description :</label>
    <textarea id="planDesc" name="description" rows="2" required placeholder="D√©crivez le plan..." style="width:100%;padding:0.5rem;border-radius:5px;border:1px solid #b0bec5;margin-bottom:1rem;font-size:1rem;"></textarea>
    <label for="planFile">Fichier du plan (PDF, JPG, PNG) :</label>
    <input type="file" id="planFile" name="plan" accept=".pdf,.jpg,.jpeg,.png" required style="width:100%;padding:0.5rem;border-radius:5px;border:1px solid #b0bec5;margin-bottom:1rem;font-size:1rem;">
    <button type="submit" style="background:#1a73e8;color:#fff;border:none;border-radius:5px;padding:0.7rem 1.5rem;font-size:1.1rem;cursor:pointer;transition:background 0.2s;">Enregistrer</button>
    <div id="planMessage" style="margin-top:1rem;"></div>
  </form>
  <div id="plansContainer"></div>
  <a href="index.html" style="text-decoration:underline;color:#1a73e8;">‚Üê Retour</a>
  <script>
    function displayPlans(plans) {
      const container = document.getElementById('plansContainer');
      if (!plans.length) {
        container.innerHTML = '<p>Aucun plan enregistr√©.</p>';
        return;
      }
      container.innerHTML = '';
      plans.forEach((plan, index) => {
        const div = document.createElement('div');
        div.className = "plan-card";
        let fileHtml = '';
        if (plan.file && ['jpg','jpeg','png','gif'].includes((plan.file.split('.').pop()||'').toLowerCase())) {
          fileHtml = `<img src="${plan.file}" alt="Plan ${index + 1}"/>`;
        } else if (plan.file && plan.file.endsWith('.pdf')) {
          fileHtml = `<embed src="${plan.file}" type="application/pdf" width="100%" height="400px"/>`;
        }
        div.innerHTML = `
          <h3>üìù Plan ${index + 1}</h3>
          <p><strong>Description :</strong> ${plan.description || ''}</p>
          <p><strong>Date :</strong> ${plan.date || ''}</p>
          ${fileHtml}
        `;
        container.appendChild(div);
      });
    }
    async function refreshPlans() {
      try {
        const r = await fetch('plans.php?api=1', {cache: 'no-store'});
        if (!r.ok) throw new Error('Erreur r√©seau');
        const text = await r.text();
        let plans;
        try {
          plans = JSON.parse(text);
        } catch (e) {
          throw new Error('R√©ponse serveur non valide (pas du JSON) : ' + text.substring(0, 200));
        }
        displayPlans(plans);
      } catch(e) {
        document.getElementById('plansContainer').innerHTML = '<p style="color:red;">Erreur lors du chargement des plans du serveur : ' + (e.message || e) + '</p>';
      }
    }
    document.getElementById('planForm').onsubmit = async function(e) {
      e.preventDefault();
      const form = e.target;
      const data = new FormData(form);
      const res = await fetch('plans.php', {
        method: 'POST',
        body: data
      });
      const text = await res.text();
      document.getElementById('planMessage').innerHTML = text;
      if(text.includes('succ√®s')) {
        form.reset();
        refreshPlans();
      }
    };
    refreshPlans();
  </script>
</body>
</html>
