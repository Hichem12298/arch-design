<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plans Enregistr√©s</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .plan-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .plan-card img, .plan-card embed {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üìÅ Plans Enregistr√©s</h1>
  <div id="plansContainer"></div>
  <a href="index.html" style="text-decoration:underline;color:#1a73e8;">‚Üê Retour</a>

  <script>
    function getPlans() {
      try {
        // Plans par d√©faut pour le site h√©berg√© (aziz hichem, aziz abdanour, aziz ahmed)
        const defaultPlans = [
          {
            description: 'aziz hichem',
            date: '2025-06-24',
            fileDataUrl: 'uploads/plan_6859a56503bad2.11142051.jpg',
            fileType: 'image/jpeg'
          },
          {
            description: 'aziz abdanour',
            date: '2025-06-24',
            fileDataUrl: 'Activty diagram memoire corrig√©.png',
            fileType: 'image/png'
          },
          {
            description: 'aziz ahmed',
            date: '2025-06-24',
            fileDataUrl: 'uploads/plan_6859a50bc5ef54.53015596.jpg',
            fileType: 'image/jpeg'
          }
        ];
        let plans = JSON.parse(localStorage.getItem('plans') || 'null');
        if (!Array.isArray(plans)) plans = [];
        // Ajoute les plans par d√©faut si aucun plan n'est d√©j√† stock√©
        if (plans.length === 0) {
          plans = defaultPlans;
          savePlans(plans);
        }
        return plans;
      } catch (e) {
        return [];
      }
    }

    function savePlans(plans) {
      localStorage.setItem('plans', JSON.stringify(plans));
    }

    const container = document.getElementById('plansContainer');
    function renderPlans() {
      const plans = getPlans();
      container.innerHTML = '';
      if (plans.length === 0) {
        container.innerHTML = "<p>Aucun plan enregistr√©.</p>";
        return;
      }
      plans.forEach((plan, index) => {
        const div = document.createElement('div');
        div.className = "plan-card";
        div.innerHTML = `
          <h3>üìù Plan ${index + 1}</h3>
          <p><strong>Description :</strong> ${plan.description}</p>
          <p><strong>Ajout√© le :</strong> ${plan.date}</p>
          ${plan.fileType === 'application/pdf'
            ? `<embed src="${plan.fileDataUrl}" type="application/pdf" width="100%" height="400px"/>`
            : `<img src="${plan.fileDataUrl}" alt="Plan ${index + 1}"/>`
          }
          <button class="delete-plan-btn" data-index="${index}" style="margin-top:1rem;background:#d32f2f;color:#fff;border:none;padding:0.5rem 1rem;border-radius:5px;cursor:pointer;">Supprimer</button>
        `;
        container.appendChild(div);
      });
      // Gestion suppression
      container.querySelectorAll('.delete-plan-btn').forEach(btn => {
        btn.onclick = function(e) {
          e.preventDefault();
          const idx = parseInt(this.getAttribute('data-index'));
          let plans = getPlans();
          if (idx >= 0 && idx < plans.length) {
            plans.splice(idx, 1);
            savePlans(plans);
            renderPlans();
          }
        };
      });
    }

    // Ajout formulaire d'ajout de plan
    const addForm = document.createElement('form');
    addForm.id = 'planForm';
    addForm.enctype = 'multipart/form-data';
    addForm.style = 'background:#f1f5fb;border-radius:8px;padding:1.5rem;margin-bottom:2rem;box-shadow:0 1px 4px #0001;max-width:500px;margin:auto;';
    addForm.innerHTML = `
      <label for="planDesc">Description :</label>
      <textarea id="planDesc" name="description" rows="2" required placeholder="D√©crivez le plan..." style="width:100%;padding:0.5rem;border-radius:5px;border:1px solid #b0bec5;margin-bottom:1rem;font-size:1rem;"></textarea>
      <label for="planFile">Fichier du plan (PDF, JPG, PNG) :</label>
      <input type="file" id="planFile" name="plan" accept=".pdf,.jpg,.jpeg,.png" required style="width:100%;padding:0.5rem;border-radius:5px;border:1px solid #b0bec5;margin-bottom:1rem;font-size:1rem;">
      <button type="submit" style="background:#1a73e8;color:#fff;border:none;border-radius:5px;padding:0.7rem 1.5rem;font-size:1.1rem;cursor:pointer;transition:background 0.2s;">Ajouter le plan</button>
      <div id="planMessage" style="margin-top:1rem;"></div>
    `;
    document.body.insertBefore(addForm, container);

    addForm.onsubmit = function(e) {
      e.preventDefault();
      const description = addForm.description.value;
      const fileInput = addForm.plan;
      const file = fileInput.files[0];
      if (!file) {
        document.getElementById('planMessage').innerHTML = '<span style="color:red;">Veuillez s√©lectionner un fichier.</span>';
        return;
      }
      const reader = new FileReader();
      reader.onload = function(ev) {
        const fileDataUrl = ev.target.result;
        let plans = getPlans();
        if (!Array.isArray(plans)) plans = [];
        plans.unshift({
          description,
          date: new Date().toLocaleString(),
          fileDataUrl,
          fileType: file.type
        });
        savePlans(plans);
        document.getElementById('planMessage').innerHTML = '<span style="color:green;">Plan ajout√© avec succ√®s !</span>';
        addForm.reset();
        renderPlans();
        // Affiche le code pr√™t √† coller dans defaultPlans
        console.log(`\n// √Ä ajouter dans defaultPlans :\n{\n  description: '${description.replace(/'/g, "\\'")}',\n  date: '${new Date().toLocaleDateString()}',\n  fileDataUrl: '${fileDataUrl}',\n  fileType: '${file.type}'\n},`);
      };
      if (file.type.startsWith('image/')) {
        reader.readAsDataURL(file);
      } else if (file.type === 'application/pdf') {
        reader.readAsDataURL(file);
      } else {
        document.getElementById('planMessage').innerHTML = '<span style="color:red;">Format de fichier non support√©.</span>';
      }
    };

    renderPlans();
  </script>
</body>
</html>
