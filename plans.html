<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Plans Enregistr√©s</title>
  <style>
    body { font-family: Arial; margin: 20px; }
    .plan-card {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }
    .plan-card img, .plan-card embed {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>üìÅ Plans Enregistr√©s</h1>
  <button id="syncLocalPlansBtn" style="margin-bottom:20px;display:none;">Synchroniser mes plans locaux</button>
  <div id="plansContainer"></div>
  <a href="index.html" style="text-decoration:underline;color:#1a73e8;">‚Üê Retour</a>
  <script>
    // Fonction pour charger les plans locaux depuis localStorage
    function getLocalPlans() {
      try {
        const plans = JSON.parse(localStorage.getItem('plans') || '[]');
        return Array.isArray(plans) ? plans : [];
      } catch (e) {
        return [];
      }
    }

    // Fonction pour afficher les plans (serveur + local)
    function displayPlans(serverPlans, localPlans) {
      const container = document.getElementById('plansContainer');
      const allPlans = [...(serverPlans||[]), ...(localPlans||[])];
      if (!allPlans.length) {
        container.innerHTML = '<p>Aucun plan enregistr√©.</p>';
        return;
      }
      container.innerHTML = '';
      allPlans.filter(plan => plan && (plan.description || plan.desc)).slice().reverse().forEach((plan, i) => {
        const div = document.createElement('div');
        div.className = 'plan-card';
        let fileHtml = '';
        if (plan.fileData && plan.fileData.startsWith('data:')) {
          // Image locale (base64)
          if (plan.fileData.startsWith('data:image/')) {
            fileHtml = `<img src="${plan.fileData}" alt="Plan local"/>`;
          } else if (plan.fileData.startsWith('data:application/pdf')) {
            fileHtml = `<embed src="${plan.fileData}" type="application/pdf" width="100%" height="400px"/>`;
          }
        } else if (plan.file && ['jpg','jpeg','png','gif'].includes((plan.file.split('.').pop()||'').toLowerCase())) {
          fileHtml = `<img src="${plan.file}" alt="Plan ${i+1}"/>`;
        } else if (plan.file && plan.file.endsWith('.pdf')) {
          fileHtml = `<p style='color:#888;font-size:0.95em;'>Aper√ßu PDF non disponible en mode public.</p>`;
        }
        div.innerHTML = `
          <h3>üìù Plan ${i + 1}</h3>
          <p><strong>Description :</strong> ${plan.description || plan.desc || ''}</p>
          ${plan.date ? `<p><strong>Ajout√© le :</strong> ${plan.date}</p>` : ''}
          ${fileHtml}
          <p style='color:#d32f2f;'><em>Pour obtenir ce plan, contactez : <a href='mailto:azizhicham136@gmail.com'>azizhicham136@gmail.com</a></em></p>
          ${plan.localOnly ? '<p style="color:#1976d2;font-size:0.95em;">(Plan local, non synchronis√©)</p>' : ''}
        `;
        container.appendChild(div);
      });
    }

    // Charger les plans du serveur
    let serverPlans = [];
    fetch('plans.php?api=1', {cache: 'no-store'})
      .then(async r => {
        if (!r.ok) throw new Error('Erreur r√©seau');
        const text = await r.text();
        try {
          return JSON.parse(text);
        } catch (e) {
          throw new Error('R√©ponse serveur non valide (pas du JSON) : ' + text.substring(0, 200));
        }
      })
      .then(plans => {
        serverPlans = plans;
        const localPlans = getLocalPlans();
        localPlans.forEach(p => p.localOnly = true);
        displayPlans(serverPlans, localPlans);
        document.getElementById('syncLocalPlansBtn').style.display = localPlans.length ? '' : 'none';
      })
      .catch((e) => {
        const localPlans = getLocalPlans();
        localPlans.forEach(p => p.localOnly = true);
        displayPlans([], localPlans);
        document.getElementById('syncLocalPlansBtn').style.display = localPlans.length ? '' : 'none';
        // Suppression de l'affichage de l'erreur de chargement
      });

    // Gestion du bouton de synchronisation
    document.getElementById('syncLocalPlansBtn').onclick = async function() {
      const localPlans = getLocalPlans();
      if (!localPlans.length) return;
      for (const plan of localPlans) {
        // Envoi via upload_plan.php (FormData)
        const fd = new FormData();
        fd.append('description', plan.description || plan.desc || '');
        // Reconvertir base64 en fichier
        if (plan.fileData && plan.fileData.startsWith('data:')) {
          const arr = plan.fileData.split(',');
          const mime = arr[0].match(/:(.*?);/)[1];
          const bstr = atob(arr[1]);
          let n = bstr.length;
          const u8arr = new Uint8Array(n);
          while(n--){ u8arr[n] = bstr.charCodeAt(n); }
          const ext = mime.includes('pdf') ? 'pdf' : (mime.split('/')[1]||'jpg');
          const file = new File([u8arr], plan.fileName || ('plan_local.'+ext), {type: mime});
          fd.append('plan', file);
        }
        await fetch('upload_plan.php', {method:'POST', body:fd});
      }
      // Vider le localStorage
      localStorage.removeItem('plans');
      alert('Plans locaux synchronis√©s !');
      location.reload();
    };
  </script>
</body>
</html>
